<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨åˆ†æå·¥å…· - é«˜çº§ç§‘æŠ€ç•Œé¢</title>
    <!-- å¼•å…¥Chart.jsç”¨äºç»˜åˆ¶æŠ˜çº¿å›¾ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥Interå­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* å…¨å±€æ ·å¼ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'æ€æºé»‘ä½“', sans-serif;
        }
        
        /* æµ…è‰²èƒŒæ™¯ */
        body {
            background-color: #f5f7fa;
            color: #333;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        
        @keyframes particleFloat {
            0% { background-position: 0 0; }
            100% { background-position: 1000px 1000px; }
        }
        
        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* æ ‡é¢˜æ ·å¼ */
        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        h1::before {
            content: 'ğŸ“ˆ';
            font-size: 1.8rem;
        }
        
        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            letter-spacing: 0.03em;
            position: relative;
            padding-bottom: 10px;
        }
        
        h2::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, #38b2ff, transparent);
        }
        
        /* æè¿°æ–‡å­— */
        p {
            color: #7f8c8d;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 30px;
            letter-spacing: 0.02em;
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-section {
            /* display: flex; */
            gap: 20px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 768px) {
            .input-section {
                grid-template-columns: 1fr;
            }
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 500;
            color: #34495e;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        input {
            padding: 12px 16px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            color: #333;
            transition: all 0.3s ease-in-out;
        }
        
        input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
            transform: translateY(-1px);
        }
        
        input::placeholder {
            color: #bdc3c7;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        button {
            margin-top: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.02em;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        button:hover::before {
            width: 300px;
            height: 300px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(56, 182, 255, 0.4);
            background: linear-gradient(135deg, #42a5f5, #1976d2);
        }
        
        button:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px -5px rgba(56, 182, 255, 0.4);
            animation: buttonTap 0.1s ease-in-out;
        }
        
        @keyframes buttonTap {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.95); }
        }
        
        /* è¿›åº¦æç¤º */
        .progress {
            margin: 20px 0;
            color: #3498db;
            font-style: italic;
            font-size: 0.95rem;
            letter-spacing: 0.02em;
        }
        
        /* å›¾è¡¨åŒºåŸŸ */
        .chart-section {
            margin: 40px 0;
            height: 400px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .chart-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.3), transparent);
        }
        
        /* è¯„è®ºåŒºåŸŸ */
        .comment-section {
            margin-top: 40px;
        }
        
        #comment {
            width: 100%;
            min-height: 140px;
            padding: 20px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            color: #333;
            resize: vertical;
            font-family: 'Inter', 'æ€æºé»‘ä½“', sans-serif;
            line-height: 1.6;
            letter-spacing: 0.01em;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        /* æ™ºèƒ½ä½“è¿›åº¦å¡ç‰‡åŒºåŸŸ */
        .agents-section {
            margin: 40px 0;
        }
        
        .agents-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 15px 0;
            scrollbar-width: auto;
            scrollbar-color: #3498db #ecf0f1;
        }
        
        /* æ™ºèƒ½ä½“ç»“æœæ˜¾ç¤ºåŒºåŸŸ */
        .agent-result {
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
            color: #555;
            min-height: 40px;
            display: flex;
            align-items: center;
            word-break: break-word;
            line-height: 1.4;
        }
        /* æ™ºèƒ½ä½“ç»“æœæœ‰å†…å®¹æ—¶çš„æ ·å¼*/
        .agent-result.has-content {
            background-color: #e3f2fd;
            border-left: 3px solid #3498db;
        }
        
        /* Webkitæµè§ˆå™¨è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        .agents-container::-webkit-scrollbar {
            height: 16px;
        }
        
        .agents-container::-webkit-scrollbar-track {
            background: #ecf0f1;
            border-radius: 4px;
        }
        
        .agents-container::-webkit-scrollbar-thumb {
            background-color: #3498db;
            border-radius: 4px;
            border: 2px solid #ecf0f1;
        }
        
        .agents-container::-webkit-scrollbar-thumb:hover {
            background-color: #2980b9;
        }
        
        /* æ™ºèƒ½ä½“å¡ç‰‡ */
        .agent-card {
            flex: 1;
            min-width: 220px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .agent-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.3), transparent);
        }
        
        .agent-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px -10px rgba(52, 152, 219, 0.2);
            border-color: rgba(52, 152, 219, 0.3);
        }
        
        .agent-card.expanded {
            min-width: 350px;
            box-shadow: 0 15px 40px -10px rgba(52, 152, 219, 0.3);
            border-color: rgba(52, 152, 219, 0.4);
        }
        
        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .agent-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
            letter-spacing: 0.03em;
        }
        
        /* çŠ¶æ€æ ‡ç­¾ */
        .agent-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            background-color: rgba(52, 152, 219, 0.1);
            color: #3498db;
            font-weight: 500;
            transition: all 0.3s ease-in-out;
        }
        
        .agent-status.running {
            background-color: rgba(243, 156, 18, 0.1);
            color: #f39c12;
            box-shadow: 0 0 10px rgba(243, 156, 18, 0.2);
        }
        
        .agent-status.completed {
            background-color: rgba(39, 174, 96, 0.1);
            color: #27ae60;
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.2);
        }
        
        .agent-status.failed {
            background-color: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.2);
        }
        
        /* è¿›åº¦æ¡ */
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #ecf0f1;
            border-radius: 3px;
            overflow: hidden;
            margin: 12px 0;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            transition: width 0.5s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* æ™ºèƒ½ä½“æ—¥å¿— */
        .agent-log {
            margin-top: 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: #555;
            background: #f8f9fa;
            padding: 0;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .agent-log.expanded {
            max-height: 300px;
            padding: 15px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 3px 0;
            border-bottom: 1px solid #e0e0e0;
            line-height: 1.5;
        }
        
        .log-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .log-entry.timestamp {
            color: #95a5a6;
            font-size: 12px;
            margin-right: 8px;
        }
        
        /* é”™è¯¯çŠ¶æ€æ ·å¼ */
        .error {
            border-color: rgba(231, 76, 60, 0.5) !important;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1) !important;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 0.85rem;
            margin-top: 5px;
            animation: errorShake 0.5s ease-in-out;
        }
        
        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            .chart-section {
                height: 300px;
                padding: 15px;
            }
            
            .agent-card {
                min-width: 280px;
            }
            
            .agent-card.expanded {
                min-width: 280px;
            }
        }
        
        /* åŠ è½½çŠ¶æ€åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>è‚¡ç¥¨åˆ†æå·¥å…·</h1>
        <p>è¾“å…¥è‚¡ç¥¨ä»£ç å’Œæ—¶é—´èŒƒå›´ï¼Œè·å–è‚¡ä»·æŠ˜çº¿å›¾åŠåˆ†æè¯„è®º</p>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="input-section">
            <div class="form-group full-width">
                <label for="userInput">è¾“å…¥æ–‡æœ¬æ®µè½</label>
                <textarea id="userInput" rows="6" placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¦åˆ†æçš„æ–‡æœ¬æ®µè½..."></textarea>
            </div>
            <button onclick="generateResult()" type="button">å¼€å§‹åˆ†æ</button>
        </div>

        <!-- è¿›åº¦æç¤º -->
        <div class="progress" id="progress"></div>

        <!-- æ™ºèƒ½ä½“è¿›åº¦å¡ç‰‡åŒºåŸŸ -->
        <div class="agents-section">
            <h2>æ™ºèƒ½ä½“æ‰§è¡ŒçŠ¶æ€</h2>
            <div class="agents-container">
                <div class="agent-card" id="taskAgentCard">
                    <div class="agent-header">
                        <span class="agent-title">ä»»åŠ¡è§£ææ™ºèƒ½ä½“</span>
                    </div>
                    <div class="agent-result" id="taskAgentResult"></div>
                </div>
                <div class="agent-card" id="searchAgentCard" >
                    <div class="agent-header">
                        <span class="agent-title">æœç´¢æ™ºèƒ½ä½“</span>
                    </div>
                    <div class="agent-result" id="searchAgentResult"></div>
                </div>
                <div class="agent-card" id="chartAgentCard" >
                    <div class="agent-header">
                        <span class="agent-title">åˆ¶å›¾æ™ºèƒ½ä½“</span>
                    </div>
                    <div class="agent-result" id="chartAgentResult"></div>
                </div>
                <div class="agent-card" id="commentAgentCard" >
                    <div class="agent-header">
                        <span class="agent-title">è¯„è®ºæ™ºèƒ½ä½“</span>
                    </div>
                    <div class="agent-result" id="commentAgentResult"></div>
                </div>

            </div>
        </div>

        <!-- æŠ˜çº¿å›¾åŒºåŸŸ
        <div class="chart-section">
            <img id="stockChart" alt="è‚¡ç¥¨å›¾è¡¨" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
        </div> -->

        <!-- è¯„è®ºåŒºåŸŸ -->
        <div class="comment-section">
            <h2>æ™ºèƒ½ä½“åˆ†æè¯„è®º</h2>
            <textarea id="comment" readonly placeholder="åˆ†æç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
        </div>
    </div>

    <script>

        // æ›´æ–°æ™ºèƒ½ä½“çŠ¶æ€å’Œç»“æœ
        function updateAgentStatus(agentName, status, result, log) {
            const statusEl = document.getElementById(`${agentName}Status`);
            const resultEl = document.getElementById(`${agentName}Result`);
            if (statusEl) {
                statusEl.classList.remove('running', 'completed', 'failed');
                statusEl.textContent = status;
                if (status === 'è¿è¡Œä¸­') statusEl.classList.add('running');
                if (status === 'å®Œæˆ') statusEl.classList.add('completed');
                if (status === 'å¤±è´¥') statusEl.classList.add('failed');
            }
            if (resultEl) {
                if (result === undefined || result === null || result === '') {
                    resultEl.classList.remove('has-content');
                    resultEl.textContent = '';
                } else {
                    resultEl.classList.add('has-content');
                    if (typeof result === 'string') {
                        resultEl.textContent = result;
                    } else {
                        try {
                            resultEl.textContent = JSON.stringify(result, null, 2);
                        } catch {
                            resultEl.textContent = String(result);
                        }
                    }
                }
            }
        }

        // é‡ç½®æ‰€æœ‰æ™ºèƒ½ä½“çŠ¶æ€
        function resetAgentsStatus() {
            const agents = ['taskAgent', 'searchAgent', 'chartAgent', 'commentAgent'];
            agents.forEach(a => updateAgentStatus(a, 'ç­‰å¾…ä¸­', '', ''));
            const commentEl = document.getElementById('comment');
            if (commentEl) commentEl.value = '';
            const progressEl = document.getElementById('progress');
            if (progressEl) progressEl.textContent = '';
            const chartEl = document.getElementById('stockChart');
            if (chartEl) {
                chartEl.removeAttribute('src');
                chartEl.setAttribute('alt', '');
            }
        }

        // ç”Ÿæˆç»“æœå‡½æ•°
        let es = null;
        function generateResult() {
            // é‡ç½® UI
            resetAgentsStatus();
        
            const progressEl = document.getElementById('progress');
            const userInputEl = document.getElementById('userInput');
        
            // æ¸…ç†æ—§é”™è¯¯
            if (userInputEl) {
                userInputEl.classList.remove('error');
                const prevError = userInputEl.parentNode.querySelector('.error-message');
                if (prevError) prevError.remove();
            }
        
            const taskText = (userInputEl?.value || '').trim();
            if (!taskText) {
                showError('userInput', 'è¯·è¾“å…¥ä»»åŠ¡å†…å®¹');
                return;
            }
        
            // å…³é—­æ—§çš„æµ
            if (es) {
                try { es.close(); } catch {}
                es = null;
            }
        
            if (progressEl) progressEl.textContent = 'æ­£åœ¨æäº¤ä»»åŠ¡...';
            const apiBase = window.location.origin;
        
            // æäº¤ä»»åŠ¡
            fetch(`${apiBase}/api/tasks`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ task: taskText })
            })
            .then(async (res) => {
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.error || `æäº¤ä»»åŠ¡å¤±è´¥(${res.status})`);
                }
                return res.json();
            })
            .then(({ taskId }) => {
                if (progressEl) progressEl.textContent = 'ä»»åŠ¡å·²æäº¤ï¼Œå¼€å§‹æ¥æ”¶å®æ—¶ç»“æœ...';
        
                // å»ºç«‹ SSE
                es = new EventSource(`${apiBase}/api/tasks/${taskId}/stream`);
        
                // ä»»åŠ¡è§£ææ™ºèƒ½ä½“
                es.addEventListener('taskAgent', (e) => {
                    const data = JSON.parse(e.data);
                    updateAgentStatus('taskAgent', 'è¿è¡Œä¸­', data.result);
                });
        
                // æœç´¢æ™ºèƒ½ä½“
                es.addEventListener('searchAgent', (e) => {
                    const data = JSON.parse(e.data);
                    updateAgentStatus('searchAgent', 'è¿è¡Œä¸­', data.result);
                });
        
                // åˆ¶å›¾æ™ºèƒ½ä½“
                es.addEventListener('chartAgent', (e) => {
                    const data = JSON.parse(e.data);
                    updateAgentStatus('chartAgent', 'è¿è¡Œä¸­', data.result);
                    const chartEl = document.getElementById('stockChart');
                    if (chartEl) {
                        const v = data.result;
                        if (typeof v === 'string' && (v.startsWith('/') || v.startsWith('http://') || v.startsWith('https://'))) {
                            chartEl.setAttribute('src', v);
                            chartEl.setAttribute('alt', 'è‚¡ç¥¨å›¾è¡¨');
                        }
                    }
                });
        
                // è¯„è®ºæ™ºèƒ½ä½“
                es.addEventListener('commentAgent', (e) => {
                    const data = JSON.parse(e.data);
                    updateAgentStatus('commentAgent', 'è¿è¡Œä¸­', data.result);
                    const commentEl = document.getElementById('comment');
                    if (commentEl) {
                        if (typeof data.result === 'string') {
                            commentEl.value = data.result;
                        } else {
                            try {
                                commentEl.value = JSON.stringify(data.result, null, 2);
                            } catch {
                                commentEl.value = String(data.result);
                            }
                        }
                    }
                });
        
                // å®Œæˆäº‹ä»¶
                es.addEventListener('done', (e) => {
                    updateAgentStatus('taskAgent', 'å®Œæˆ', '', '');
                    updateAgentStatus('searchAgent', 'å®Œæˆ', '', '');
                    updateAgentStatus('chartAgent', 'å®Œæˆ', '', '');
                    updateAgentStatus('commentAgent', 'å®Œæˆ', '', '');
                    if (progressEl) progressEl.textContent = 'åˆ†æå®Œæˆ';
                    try { es.close(); } catch {}
                    es = null;
                });
        
                // é”™è¯¯å¤„ç†ï¼ˆæœåŠ¡å™¨æ–­æµæˆ–ç½‘ç»œå¼‚å¸¸ï¼‰
                es.onerror = (err) => {
                    updateAgentStatus('taskAgent', 'å¤±è´¥', '', '');
                    updateAgentStatus('searchAgent', 'å¤±è´¥', '', '');
                    updateAgentStatus('chartAgent', 'å¤±è´¥', '', '');
                    updateAgentStatus('commentAgent', 'å¤±è´¥', '', '');
                    if (progressEl) progressEl.textContent = 'æµè¿æ¥å‡ºç°é”™è¯¯æˆ–ä¸­æ–­';
                    try { es.close(); } catch {}
                    es = null;
                };
            })
            .catch((err) => {
                if (progressEl) progressEl.textContent = '';
                showError('userInput', err.message || 'è¯·æ±‚å¤±è´¥');
            });
        }

            function startSSE(taskId, apiBase) {
                const progressEl = document.getElementById('progress');
                const chartEl = document.getElementById('stockChart');
                const commentEl = document.getElementById('comment');
        
                const url = `${apiBase}/api/tasks/${encodeURIComponent(taskId)}/stream`;
                es = new EventSource(url);
        
                es.addEventListener('open', () => {
                    if (progressEl) progressEl.textContent = 'æµå·²è¿æ¥ï¼Œç­‰å¾…æ™ºèƒ½ä½“è¾“å‡º...';
                });
        
                // ä»»åŠ¡è§£ææ™ºèƒ½ä½“
                es.addEventListener('Task_Analysis_Agent', (ev) => {
                    const payload = safeParse(ev.data);
                    updateAgentStatus('taskAgent', toCNStatus(payload.status), payload.result ?? '');
                });
        
                // æœç´¢æ™ºèƒ½ä½“
                es.addEventListener('Search_Agent', (ev) => {
                    const payload = safeParse(ev.data);
                    updateAgentStatus('searchAgent', toCNStatus(payload.status), payload.result ?? '');
                });
        
                // åˆ¶å›¾æ™ºèƒ½ä½“
                es.addEventListener('Plotting_Agent', (ev) => {
                    const payload = safeParse(ev.data);
                    updateAgentStatus('chartAgent', toCNStatus(payload.status), payload.result ?? '');
                    if (payload.imageUrl && chartEl) {
                        chartEl.setAttribute('src', payload.imageUrl);
                        chartEl.setAttribute('alt', 'è‚¡ç¥¨å›¾è¡¨');
                    }
                });
        
                // è¯„è®ºæ™ºèƒ½ä½“ï¼ˆæœ€åä¸€ä¸ªæ™ºèƒ½ä½“ï¼‰
                es.addEventListener('Report_Agent', (ev) => {
                    const payload = safeParse(ev.data);
                    updateAgentStatus('commentAgent', toCNStatus(payload.status), payload.result ?? '');
                    if (commentEl) {
                        // fullComment: åç«¯èšåˆçš„å®Œæ•´è¯„è®ºï¼ˆæ¨èï¼‰
                        // è‹¥æœªæä¾›ï¼Œåˆ™å›è½åˆ° result å­—æ®µ
                        commentEl.value = payload.fullComment ?? (typeof payload.result === 'string' ? payload.result : JSON.stringify(payload.result ?? '', null, 2));
                    }
                });
        
                // è¿›åº¦æç¤º
                es.addEventListener('progress', (ev) => {
                    const payload = safeParse(ev.data);
                    if (progressEl) progressEl.textContent = payload.message ?? '';
                });
        
                // å®Œæˆæ”¶å°¾
                es.addEventListener('done', (ev) => {
                    const payload = safeParse(ev.data);
                    if (progressEl) progressEl.textContent = payload.message ?? 'æ‰€æœ‰æ™ºèƒ½ä½“å·²å®Œæˆ';
                    try { es.close(); } catch {}
                    es = null;
                });
        
                // é€šç”¨æ¶ˆæ¯ï¼ˆå¯é€‰å…œåº•ï¼‰
                es.addEventListener('message', (ev) => {
                    const payload = safeParse(ev.data);
                    if (payload && payload.agent) {
                        updateAgentStatus(payload.agent, toCNStatus(payload.status), payload.result ?? '');
                    }
                });
        
                es.addEventListener('error', () => {
                    if (progressEl) progressEl.textContent = 'SSEè¿æ¥é”™è¯¯æˆ–å·²å…³é—­';
                    try { es.close(); } catch {}
                    es = null;
                });
            }
        
        // å®‰å…¨è§£æ
        function safeParse(data) {
            try { return JSON.parse(data); } catch { return {}; }
        }

        // çŠ¶æ€ç¿»è¯‘ï¼ˆåç«¯å»ºè®®è¿”å› running/completed/failedï¼‰
        function toCNStatus(status) {
            switch (status) {
                case 'running': return 'è¿è¡Œä¸­';
                case 'completed': return 'å®Œæˆ';
                case 'failed': return 'å¤±è´¥';
                default: return 'ç­‰å¾…ä¸­';
            }
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(inputId, message) {
            const input = document.getElementById(inputId);
            input.classList.add('error');
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰é”™è¯¯æ¶ˆæ¯
            if (!input.parentNode.querySelector('.error-message')) {
                const errorEl = document.createElement('div');
                errorEl.className = 'error-message';
                errorEl.textContent = message;
                input.parentNode.appendChild(errorEl);
            }
        }
    </script>
</body>
</html>
